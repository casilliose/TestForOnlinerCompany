# Тестовое задание для Onliner

## Старт проекта 
>Для старта проекта нужено установить docker и docker-compose<br>
>Затем выкачиваем репозиторий, открываем терминал, заходим<br>
>в раздел проекта и запускаем команду `cd ci && sudo bash start-project.sh`
>затем перейти в браузер и открыть http://localhost:9100 увидим приветсвие Like at Home!

##  Роуты
`/example/{pageId}` эмуляция 10000 тыс страниц
эти страница как раз и собирают статистику посещений
компонет `VisitsCounterPage::counterPage` можно вызвать
в любом другом роуте и собирать статистику посещений для
других страниц

`/analytics`
Страница показывает самые посещаемые страници
за каждый день

`/removeold/{year}`
Получает год за который не нужно хранить данные
и удаляет таблицы для этого года

## Реализация
Сесси PHP на Redis cluster сроком на 30 дней
так я идентифицирую юзера и распределяю нагрузку
по подсчету посещений на ноды, сесси на cookie

База данных MySql хранит партицирование за день
в формате url = count
таким образом нужно будет всего 18250000 строк за 5 лет
что будет равняться 2GB данных максимум
за счет портицирование по дню в каждой таблице
будет всего 10тыс записей о url
что позволит делать быстрые выборки и агрегации
если нужна будет смежная выборка по нескольним дням
использую асинхронные запросы на каждый день
быстро получим данные и сделаем нужные прощеты
и агрегации на php

Если нужно использовать счетчик на стороннем сайте
можно сделать без JS так
`<style>
    #iframeCountPage {
      opacity: 0; 
      visibility: hidden;
      border: 0;
      outline: 0;
      width: 0;
      height: 0;
    }
</style>
<iframe id="iframeCountPage" src="http://localhost:9100/"></iframe>`
Добавить обработчик `VisitsCounterPage::counterPage` в роут `/`
и использовать не `getRequestUri` а использовать `referer`

## PS
Хотелось бы покрыть интеграционными тестами еще но нет времени,
и изучить какую ни будь noSql БД возможно clickHouse или Vertica
лучше подходят для хранения таких данных и запросов аналитики по ним
для этого я сделал интерфейс Storage что бы можно было безболезненно
сменить хранилище